#!/bin/bash
# Use this script to generate dependencies required to build the
# base Zimbra SOLR image (zm-solr-docker).
#
# ASSUMPTIONS
#
# 1. You are using a standard development configuration as encoded in docker-zcs-dev-machine.
# 2. You have copied this script to the top-level directory of you development build container
#    where you have the below-listed git repos checked out.
#
# Prerequisites:
#
# 1. Check out the develop branch of zm-zcs
# 2. Check out the feature/solr branch of zm-build. If necessary create & populate the
#    following files in zm-build/RE: MAJOR, MINOR, MICRO
# 3. Check out the feature/solr branch of zm-mailbox
#    Run `ant clean` from zm-mailbox directory
#    Run `ant publish-foss-local` from zm-mailbox/store directory
# 4. Check out the feature/solr branch of zm-solr and run `ant clean compile jar` from
#    inside zm-solr.
#
# Generating uploading the SOLR deps
#
# 1. Run this script.  You should end up with an archive like this:
#      zm-solr-docker-deps-20180212.tar.gz
#    It will have the current date stamp.
# 2. This archive should be uploaded to S3 (docker.zimbra.com/assets).
#    Make sure it has EVERYONE/READ permissions.

set -euxo pipefail

ZSD="zm-solr-docker-deps"
ZS="zm-solr"
ZM="zm-mailbox"
IVY_CACHE="/home/zimbra/.ivy2/cache"
TAR="${ZSD}-$(date +'%Y%m%d').tar.gz"
solr_home="$ZSD/opt/solr/server/solr"

mkdir -p "$solr_home"
cp "$ZS/conf/solr.xml" "$solr_home/solr.xml"
cp "$ZS/conf/zoo.cfg" "$solr_home/zoo.cfg"
mkdir -p "$solr_home/configsets"
cp -r "$ZS/conf/configsets/zimbra" "$solr_home/configsets/"
cp -r "$ZS/conf/configsets/events" "$solr_home/configsets/"
mkdir -p "$solr_home/lib"
cp "$ZS/build/solrplugins.jar" "$solr_home/lib/solrplugins.jar"
cp $ZM/common/build/zm-common*.jar "$solr_home/lib/"
cp "$IVY_CACHE/javax.mail/mail/jars/mail-1.4.5.jar" "$solr_home/lib/"

tar cfz ${TAR} $ZSD
chmod 777 ${TAR}
